wgsd-ucode
==========

Implementation of [wgsd][1] on OpenWRT's [ucode][2].

Goal of that implementation is to support AmneziaWG, a variation of WireGuard.
It have a little bit different netlink protocol, so usual Golang wireguard control module would not work.
So instead of forking all required parts, I decided just to script that out on the existing language.
That also makes whole thing much smaller, as you don't have to carry Go runtime.

This version has tho parts:

- `wgsd-registry` - a registry side part, which generates zone file for DNS server
- `wgsd-client-ucode` - client, which resolves endpoints and updates WG/AWG endpoints


Installation
------------

This repository is an OpenWRT feed with extra packages.

1. Add this line to `feeds.conf`:
```
src-git wgsduc https://github.com/vooon/wgsd-ucode.git
```

2. Run feeds update & install:
```shell
./scripts/feeds update -a
./scripts/feeds install -a
```

3. Then in `menuconfig` select:
   - *Network* -> *VPN* -> *wgsd-registry* (and *wgsd-registry-awg* for AmneziaWG)
   - *Network* -> *VPN* -> *wgsd-client-ucode* (and *wgsd-client-ucode-awg* for AmneziaWG)

> [!NOTE]
> `*-awg` packages is a metapackage to select additional dependencies needed for AmneziaWG support.


wgsd-registry
-------------

This service periodically regenerates RFC1035 DNS zone files.
Generated file locates in `/tmp/wgsd/<zone>.zone`.

Configuration done trough the UCI interface. Service can run multiple instances for each interface.

Instances defined by config section of type `registry`. See the [example file](./wgsd-registry/files/wgsd-registry.conf).

| Option | Req | Description |
|--------|-----|-------------|
| disabled | No | Disable registry instance. Default 0. |
| interface | Yes | Network interface, must be of `wireguard` or `amneziawg` protocol |
| zone | Yes | Base domain zone. Must end with dot. |
| ttl | No | Time to leave for records and file regeneration. Default 60 seconds. |

> [!NOTE]
> In the contrast to the original `wgsd` plugin it does not provide you a DNS server.
> But that gives you flexibility to choose whatever NS server you want.
> The only requirement for the server is to be able to automatically reload zone file on change or by time.


wgsd-client-ucode
-----------------

Discovery client, that setup endpoints published by registry.

```
wgsd-client-ucode -i <INTERFACE> -s <DNS-SERVER> -z <ZONE>
```

| Option | Req | Description |
|--------|-----|-------------|
| `-i <INTERFACE>`  | Yes | Interface name. |
| `-s <DNS-SERVER>` | Yes | DNS server that serves registry zone(s), `<host-or-ip>[:<port>]` |
| `-z <ZONE>`       | Yes | Registry zone name. |

Add line like that to cron tab:
```cron
1,6,11,16,21,26,31,36,41,46,51,56 * * * * wgsd-client-ucode -i vpn_wg -s ns.example.com:5353 -z wg.example.com
```


Extra packages
--------------

### ucode-mod-base32

The module provides Base32 encoding/decoding functions to ucode.
Unfortunately base language has only Base64.

### rpcd-mod-amneziawg

Plugin for rpcd to support AmneziaWG calls.
It's a copy of `rpcd-mod-wireguard` modified for `proto=amneziawg`.

### prometheus-node-exporter-ucode-amneziawg

A collector plugin for `prometheus-node-exporter-ucode`.
Modified version of `prometheus-node-exporter-ucode-wireguard`.

### CoreDNS

A copy of package I sent to [packages#26900][3].

It contains original `wgsd` plugin (optional), but I use it to serve zones generated by `wgsd-registry`, like that:

```corefile
wg.example.com.:5353 {
  log
  file /tmp/wgsd/wg.example.com.zone {
    reload 60s
  }
}
```


[1]: https://github.com/jwhited/wgsd
[2]: https://ucode.mein.io/
[3]: https://github.com/openwrt/packages/pull/26900
